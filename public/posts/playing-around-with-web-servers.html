<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="../..//themes/ds/assets/bundle.css?v=1">
        <title>Playing Around With Web Servers</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
    </head>
    <body class="posts slug-playing-around-with-web-servers blog">
<nav class="navbar is-black" role="navigation" aria-label="main navigation">
    <div class="container">
        <div class="navbar-brand">
            <a class="navbar-item" href="/">Home</a>
            
            <a role="button" class="navbar-burger" data-target="primary-menu" aria-label="menu" aria-expanded="false">
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
                <span aria-hidden="true"></span>
            </a>
        </div>

        <div class="navbar-menu" id="primary-menu">

        </div>
    </div>
</nav>

<header class="hero is-primary">   
    <div class="hero-body">
        <div class="container">
            <h2 class="title is-2">Hola, I'm Duane</h2>
            <h3 class="subtitle is-5">A few interesting things about me:</h3>

            <div class="columns has-text-centered">
                <div class="column">
                    <div class="fas fa-code"> </div> 
                    <p class="desc">I've developed software used by over 40 million people, including the previous media engine in Yahoo! Messenger.</p>
                    <p><a class="button is-primary is-small" href="/topic/code/">More Software</a></p> 
                </div>
                <div class="column is-hidden-touch">
                    <div class="fas fa-wrench"> </div> 
                    <p class="desc">I engineer lots of cool things such as hi-fi audio amplifiers and solar batteries for camping.</p>
                    <p><a class="button is-primary is-small"  href="/topic/projects/">More Projects</a></p> 
                </div>
                <div class="column">
                    <div class="fas fa-chart-bar"> </div> 
                    <p class="desc">I co-wrote the previous #1 plugin for WordPress (out of 20,000), WPtouch, and eventually sold it.</p>
                    <p><a class="button is-primary is-small" href="/topic/business/">More Business</a></p> 
                </div>
                <div class="column">
                    <div class="fas fa-plane-departure"> </div> 
                    <p class="desc">I've visited 44 countries in the last seven years and currently live in Valencia on the eastern coast of Spain.</p><p>
                    <a class="button is-primary is-small" href="/topic/travel/">More Travel</a></p>
                </div>
                <div class="column is-hidden-mobile">
                    <div class="fas fa-camera-retro"> </div> 
                    <p class="desc">I am a published concert, travel, portrait, and landscape photographer; I currently shoot Fuji XT lenses.</p>
                    <p><a class="button is-primary is-small"  href="/topic/photography/">More Photography</a></p> 
                </div>
            </div>
        </div>

        <div class="container newsletter">
            <div class="has-text-centered">
                <p>Sign-up to my exclusive business-oriented mailing list for occassional updates:</p>
                <form action="//migratorynerd.us7.list-manage.com/subscribe/post?u=80cbf36c84f738b5623a02a85&amp;id=97101f05dd" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
                    <div id="mc_embed_signup_scroll">
                        <div class="mc-field-group">
                            <input type="email" placeholder="Enter your email address...." name="EMAIL" class="required email" id="mce-EMAIL"><input type="submit" value="Join 725 Subscribers" name="subscribe" id="mc-embedded-subscribe" class="button is-info"><input type="submit" value="Sign-up" name="subscribe" id="mc-embedded-subscribe-mobile" class="button is-info">
                        </div>
                        <div id="mce-responses" class="clear">
                            <div class="response" id="mce-error-response" style="display:none"></div>
                            <div class="response" id="mce-success-response" style="display:none"></div>
                        </div>   
                        <div style="position: absolute; left: -5000px;" aria-hidden="true">
                            <input type="text" name="b_80cbf36c84f738b5623a02a85_97101f05dd" tabindex="-1" value="">
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</header>



    <article class="main section content">
        <div class="container">
            <p>Obviously I've been spending a bit of time tweaking Apache such that it is well optimized for working in a VPS environment. Truthfully though, Apache is a major resource hog. To be honest, I really can't comprehend what it's doing with all that memory it seems to hoard. One of the other major downsides to Apache is that it forks additional processes to handle server load, and processes are rather heavy (at least when compared to user threads).</p>
<p>Since I haven't touched any C++ in about two months, I thought I'd try my hand at writing a quick web server to see if I can better understand some of problems. For now, I'm leveraging boost for all the threading, and just using simple select now for all the socket communication (I understand the limitations of select, and will probably move things to boost::asio when it's all done).</p>
<p>I originally wrote it using a half-async pattern, but found that I was having problems getting the threading the way I wanted without having lock contention going on between threads. So I've pretty much abandoned that in favor of a fully asynchronous architecture, which is trickier to handle but ultimately gets rid of nearly all of the locks. I still haven't really figured out the best way to handle memory, but obviously some type of pool is going to be required for high efficiency. One of the areas I spent a lot of time with at my last job was optimizing code for speed, so I'm hoping I can bring some of that to the web space problem as well.</p>
<p>In terms of the actual server, right now there's a main thread handling all the dispatching and communications, and a pool of worker threads handling the actual web traffic. It's a typical web traffic architecture, and I plan to pick it apart when I'm done to see if it actually makes sense.</p>
<p>In about four hours in front of the TV yesterday I managed to get the web server (affectionately called Webby right now) to serve static content. I'm using four threads right now for the worker pool, but it's completely configurable (I'm guessing around four threads per core is probably ideal). Once I had that working, I decided to take a stab at getting PHP code to work. I did some basic stress testing at this point (no point in continuing if I can't blow Apache away). I did 10,000 requests for static content using Apache, and 10,000 requests for the same content using Webby. Apache took 42.5 seconds to serve a static HTML file over the LAN, which amounts to around 235 individual requests per second. Webby did it in about 3.28 seconds.</p>
<p>Apache has an distinct advantage because PHP can be built as a module for it, basically loading PHP into Apache. Given that this is just something I'm doing for fun, I don't really want to spend the time doing that at this point. So my only options at this point are to drop to the OS and execute PHP, or execute it as a CGI. I tried the former, and it was painfully slow. So that basically meant going the CGI route.</p>
<p>The best way to do CGI is using Fast CGI, which is something I've never done before. Basically you open a local socket to a server running PHP, and send it requests to process scripts. I ended up writing a mini Fast CGI library, since I couldn't find one that was usable. It took me a few hours, but it seems to be working now with PHP.</p>
<p>I still have a few major optimizations to do before I can test out the PHP part properly (you have to initialize PHP with various variables before WordPress will work properly), but maybe next weekend I can set aside an afternoon and finish it off.</p>
<p>Apache's major detriment is that it's such a memory hog. Without a doubt, one of the major advantages to Webby in a low memory environment is that it won't start trashing into swap space as soon as Apache will. I also will be able to adjust the stack size per thread (something that I haven't done yet), so conceivably I could get the memory foot print even lower (although right now Webby is using around 1.5 MB of memory, whereas Apache is using around 120 MB I believe).</p>
        </div>
    </article>

            <div class="footer has-text-centered">
           <div class="level">
                <div class="level-left">
                   
                </div>
                <div class="level-right">
                    All content &copy; Copyright 2009 by Duane Storey &amp; Lindell Media Solutions Inc.
                </div>
            </div>
        </div>
        
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-2124361-1"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){ dataLayer.push(arguments); }
            gtag('js', new Date());

            gtag('config', 'UA-2124361-1');
        </script>
    </body>
</html>